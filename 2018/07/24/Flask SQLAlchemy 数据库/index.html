<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Flask SQLAlchemy 数据库 | Sxadmin blog</title><meta name="description" content="Flask使用数据库模型，处理映射关系，定义基础的模型类。使用不同的连接数据库的方式创建与连接数据库。"><meta name="keywords" content="Flask 数据库,sqlalchemy,数据库映射"><meta name="author" content="Sxadmin"><meta name="copyright" content="Sxadmin"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="https://s1.ax1x.com/2020/06/15/NpA1v6.th.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="dns-prefetch" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="dns-prefetch" href="https://fonts.googleapis.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="dns-prefetch" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Flask SQLAlchemy 数据库"><meta name="twitter:description" content="Flask使用数据库模型，处理映射关系，定义基础的模型类。使用不同的连接数据库的方式创建与连接数据库。"><meta name="twitter:image" content="https://sxadmin.github.io/img/cover/cover12.png"><meta property="og:type" content="article"><meta property="og:title" content="Flask SQLAlchemy 数据库"><meta property="og:url" content="https://sxadmin.github.io/2018/07/24/Flask%20SQLAlchemy%20%E6%95%B0%E6%8D%AE%E5%BA%93/"><meta property="og:site_name" content="Sxadmin blog"><meta property="og:description" content="Flask使用数据库模型，处理映射关系，定义基础的模型类。使用不同的连接数据库的方式创建与连接数据库。"><meta property="og:image" content="https://sxadmin.github.io/img/cover/cover12.png"><meta property="article:published_time" content="2018-07-24T05:27:03.000Z"><meta property="article:modified_time" content="2020-06-15T03:37:25.785Z"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="https://sxadmin.github.io/2018/07/24/Flask%20SQLAlchemy%20%E6%95%B0%E6%8D%AE%E5%BA%93/"><link rel="prev" title="Flask-Movie-小项目实战" href="https://sxadmin.github.io/2018/08/15/Flask-Movie-%E5%B0%8F%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/"><link rel="next" title="Flask Wtforms 表单验证" href="https://sxadmin.github.io/2018/07/22/Flask%20Wtforms%20%E8%A1%A8%E5%8D%95%E9%AA%8C%E8%AF%81/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.1"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='https://s1.ax1x.com/2020/06/15/NpPYfx.jpg'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">88</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">60</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">10</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首頁</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 時間軸</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 標籤</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分類</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友鏈</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 關於</span></a></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#创建数据库方式"><span class="toc-number">1.</span> <span class="toc-text">创建数据库方式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#模型创建与映射"><span class="toc-number">2.</span> <span class="toc-text">模型创建与映射</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#模型概念"><span class="toc-number">2.1.</span> <span class="toc-text">模型概念</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建妹子图项目模型"><span class="toc-number">2.2.</span> <span class="toc-text">创建妹子图项目模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#妹子图项目映射到数据库"><span class="toc-number">2.3.</span> <span class="toc-text">妹子图项目映射到数据库</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#不同连接数据库插件使用方法"><span class="toc-number">3.</span> <span class="toc-text">不同连接数据库插件使用方法</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#方法一：使用Pymysql与SQLAlchemy操作数据库"><span class="toc-number">4.</span> <span class="toc-text">方法一：使用Pymysql与SQLAlchemy操作数据库</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#方法二：使用SQLALchemy操作数据库"><span class="toc-number">5.</span> <span class="toc-text">方法二：使用SQLALchemy操作数据库</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#初始化对象"><span class="toc-number">5.1.</span> <span class="toc-text">初始化对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建数据库模型"><span class="toc-number">5.2.</span> <span class="toc-text">创建数据库模型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#数据库外键关联"><span class="toc-number">5.3.</span> <span class="toc-text">数据库外键关联</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#执行创建数据库"><span class="toc-number">5.4.</span> <span class="toc-text">执行创建数据库</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#增删改查"><span class="toc-number">5.5.</span> <span class="toc-text">增删改查</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#增"><span class="toc-number">5.5.1.</span> <span class="toc-text">增</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#删"><span class="toc-number">5.5.2.</span> <span class="toc-text">删</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#查"><span class="toc-number">5.5.3.</span> <span class="toc-text">查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#改"><span class="toc-number">5.5.4.</span> <span class="toc-text">改</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实例演示一"><span class="toc-number">5.5.5.</span> <span class="toc-text">实例演示一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实例演示二"><span class="toc-number">5.5.6.</span> <span class="toc-text">实例演示二</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#添加数据"><span class="toc-number">5.5.6.1.</span> <span class="toc-text">添加数据</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#创建一个person对象"><span class="toc-number">5.5.6.1.1.</span> <span class="toc-text">创建一个person对象</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#添加person对象，但是仍然没有commit到数据库"><span class="toc-number">5.5.6.1.2.</span> <span class="toc-text">添加person对象，但是仍然没有commit到数据库</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#commit操作"><span class="toc-number">5.5.6.1.3.</span> <span class="toc-text">commit操作</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#获取所有数据"><span class="toc-number">5.5.6.1.4.</span> <span class="toc-text">获取所有数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#获取某一列数据-类似于django的get-如果返回数据为多个则报错"><span class="toc-number">5.5.6.1.5.</span> <span class="toc-text">获取某一列数据,类似于django的get,如果返回数据为多个则报错</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#获取返回数据的第一行"><span class="toc-number">5.5.6.1.6.</span> <span class="toc-text">获取返回数据的第一行</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#过滤数据"><span class="toc-number">5.5.6.1.7.</span> <span class="toc-text">过滤数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#limit"><span class="toc-number">5.5.6.1.8.</span> <span class="toc-text">limit</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#order-by"><span class="toc-number">5.5.6.1.9.</span> <span class="toc-text">order by</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#equal-like-in"><span class="toc-number">5.5.6.1.10.</span> <span class="toc-text">equal&#x2F;like&#x2F;in</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#and-or"><span class="toc-number">5.5.6.1.11.</span> <span class="toc-text">and or</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#使用text"><span class="toc-number">5.5.6.1.12.</span> <span class="toc-text">使用text</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#计数"><span class="toc-number">5.5.6.1.13.</span> <span class="toc-text">计数</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#group-by的用法"><span class="toc-number">5.5.6.1.14.</span> <span class="toc-text">group by的用法</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#实现count-来查询表内行数"><span class="toc-number">5.5.6.1.15.</span> <span class="toc-text">实现count(*)来查询表内行数</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Pymysql-with-操作"><span class="toc-number">6.</span> <span class="toc-text">Pymysql with 操作</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SQLALchemy-with操作"><span class="toc-number">7.</span> <span class="toc-text">SQLALchemy with操作</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#数据库连接池"><span class="toc-number">8.</span> <span class="toc-text">数据库连接池</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#PersistentDB-模式"><span class="toc-number">8.1.</span> <span class="toc-text">PersistentDB 模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PooledDB-模式"><span class="toc-number">8.2.</span> <span class="toc-text">PooledDB 模式</span></a></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(/img/cover/cover12.png)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">Sxadmin blog</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首頁</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 時間軸</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 標籤</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分類</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> 友鏈</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> 關於</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Flask SQLAlchemy 数据库</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2018-07-24 13:27:03"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2018-07-24</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-06-15 11:37:25"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-06-15</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/WEB-%E5%90%8E%E7%AB%AF%E6%A1%86%E6%9E%B6/">WEB 后端框架</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><blockquote class="blockquote-center">看着一双美丽的眼睛流动着对那个时代的向往，不由得让人也期待啊。</blockquote>

<script type="text/javascript" src="/js/src/bai.js"></script>

<h1 id="创建数据库方式"><a href="#创建数据库方式" class="headerlink" title="创建数据库方式"></a>创建数据库方式</h1><ol>
<li>Database First  # 使用navicat图形化管理工具一步一步创建</li>
<li>Moedl First     # 使用navicat的画图工具画出结构，然后自动生成</li>
<li>Code First       # 用Python写好数据库的模型，不用专门写SQL语句,主要解决创建数据的问题，专注于业务模型的设计。</li>
</ol>
<h1 id="模型创建与映射"><a href="#模型创建与映射" class="headerlink" title="模型创建与映射"></a>模型创建与映射</h1><h2 id="模型概念"><a href="#模型概念" class="headerlink" title="模型概念"></a>模型概念</h2><p>关于MVC方式，个人这么理解：</p>
<pre><code>M --&gt; model模块，主要的核心函数处理模块，负责处理大部分的业务的业务模型
V --&gt; view模块，视图模块，负责展现出好看的界面
c --&gt; ctrol模块，操作控制模块，负责处理控制部分</code></pre><p>ORM:对象关系映射，包括数据创建过程，数据查询过程，删除，更新的过程。ORM操作数据库模型<br>来间接的操作数据库。</p>
<p>后期的所有数据库操作都是通过ORM来操作的。</p>
<h2 id="创建妹子图项目模型"><a href="#创建妹子图项目模型" class="headerlink" title="创建妹子图项目模型"></a>创建妹子图项目模型</h2><p>首先在数据库中创建好数据库，数据库名字为meizi，字符集为utf8mb4 – UTF-8 Unicode,排序规则为utf8mb4_general_ci</p>
<p>还是使用之前的妹子图的小项目，先创建目录data，然后新建creata_database.py，准备创建数据库结构，需要的数据结构大致如下</p>
<pre><code>class data():
    id = None
    # id号
    title = &apos;&apos;
    # 页面标题
    url = &apos;&apos;
    # 该页面的主网址
    show_img = &apos;&apos;
    # 页面的单张展示图片
    all_img = &apos;&apos;
    # 页面的所有图片


    def sample(self):
        pass</code></pre><p>然后使用sqlalchemy把结构直接映射到数据库，非常方便。这里提起一下，sqlalchemy不是flask自带的，但是falsk对sqlalchemy做了部分的优化，使用pipenv install flask-sqlalchemy即可安装。</p>
<p>ok，下面的新建的数据库模型</p>
<pre><code># -*- coding: utf-8 -*-
# @Time    : 2018/7/24 0024 13:40
# @Author  : Langzi
# @Blog    : www.sxadmin.github.io
# @File    : creata_database.py
# @Software: PyCharm
import sys
from sqlalchemy import Column,Integer,String
# 导入column（字段），Integer（数字类型）
reload(sys)
sys.setdefaultencoding(&apos;utf-8&apos;)

class data():
    id = Column(Integer,primary_key=True,autoincrement=True)
    # 设置id号为数据库的主键，并且自增长
    # 相当于SQL:id int primary key auto_increment
    title = Column(String(100),nullable=True,default=&apos;获取该妹子信息失败&apos;)
    # 页面标题长度为100，并且允许为空，如果为空的话就生成上面的default
    url = Column(String(100),nullable=False,unique=True)
    # 该页面的主网址长度100，不允许为空,不允许重复
    show_img = Column(String(100),nullable=False)
    # 页面的单张展示图片
    all_img = Column(String(100),nullable=False)
    # 页面的所有图片


    def sample(self):
        pass</code></pre><h2 id="妹子图项目映射到数据库"><a href="#妹子图项目映射到数据库" class="headerlink" title="妹子图项目映射到数据库"></a>妹子图项目映射到数据库</h2><p>然后实例化sql的对象，新增代码：</p>
<pre><code>from flask_sqlalchemy import SQLAlchemy
# 实例化sqlalchemy对象，在flask中导入进来
db = SQLAlchemy()
# db就是sqlalchemy的初始化的核心对象
class data(db.Model):
    id= xxx重复上面的代码</code></pre><p>把之前的类继承db即可。然后回到主目录下的init.py文件下，该文件之前是把蓝图注册到app里面的，之前的init.py代码如下</p>
<pre><code># -*- coding: utf-8 -*-
# @Time    : 2018/7/19 0019 18:36
# @Author  : Langzi
# @Blog    : www.sxadmin.github.io
# @File    : __init__.py.py
# @Software: PyCharm
import sys
from flask import Flask
from app.web.data.creata_database import db
reload(sys)
sys.setdefaultencoding(&apos;utf-8&apos;)

def create_app():
    app = Flask(__name__,template_folder=(&apos;web/templates&apos;))
    app.config.from_object(&apos;config&apos;)
    start_Blueprint(app)
    return app

def start_Blueprint(app):
    from app.web.Mmzi import web
    app.register_blueprint(web)</code></pre><p>导入data目录下create_database.py中的db对象，然后注册到app当中并且初始化对象，并且调用他。</p>
<pre><code># -*- coding: utf-8 -*-
# @Time    : 2018/7/19 0019 18:36
# @Author  : Langzi
# @Blog    : www.sxadmin.github.io
# @File    : __init__.py.py
# @Software: PyCharm
import sys
from flask import Flask
#from app.web.data.creata_database import db
reload(sys)
sys.setdefaultencoding(&apos;utf-8&apos;)

def create_app():
    app = Flask(__name__,template_folder=(&apos;web/templates&apos;))
    app.config.from_object(&apos;config&apos;)
    start_Blueprint(app)
    db.init_app(app)
    with app.app_context():
       db.create_all()
    return app

def start_Blueprint(app):
    from app.web import web
    app.register_blueprint(web)</code></pre><p>app就像一个插板一样，蓝图可以注册到app里面，路由注册到app里面，甚至数据库也可以注册到app里面，后期的登录等模块一样注册到里面，当前已经差不多配置完成了，还有重要的一点没说，那就是链接到哪个数据库里面。</p>
<p>在主目录下的config.py中可以添加数据库的配置信息，之前config之定义了DEBUG的开关，这个时候可以加入数据库配置。</p>
<p>SQLAlchemy本身无法操作数据库，其必须以来pymsql，cymysql，mysqldb等第三方插件，根据配置文件的不同调用不同的数据库API，从而实现对数据库的操作，下面使用过cymysql进行操作</p>
<p>app主目录下的config.py配置文件</p>
<pre><code># -*- coding: utf-8 -*-
# @Time    : 2018/7/17 0017 20:42
# @Author  : Langzi
# @Blog    : www.sxadmin.github.io
# @File    : config.py
# @Software: PyCharm
import sys

reload(sys)
sys.setdefaultencoding(&apos;utf-8&apos;)

DEBUG = True

SQLALCHEMY_DATABASE_URI = &apos;mysql+cymysql://root:root@127.0.0.1:3306/meizi&apos;
# SQLALCHEMY_DATABASE_URI是flask定义好的配置项，就像DEBUG一样
# mysql + cymysql ： 使用mysql数据库，驱动使用cymysql（需要pipenv install cymysql）,你还可以使用pymysql
# 然后数据库账号密码,主机和端口以及数据库名字</code></pre><p>最后允许主程序的时候，会发现数据库中多了一个名为meizi的数据库，其中多了一张名为data的表，数据库的结构和定义的结构一致。</p>
<h1 id="不同连接数据库插件使用方法"><a href="#不同连接数据库插件使用方法" class="headerlink" title="不同连接数据库插件使用方法"></a>不同连接数据库插件使用方法</h1><pre><code>MySQL-Python
    mysql+mysqldb://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;[:&lt;port&gt;]/&lt;dbname&gt;

pymysql
    mysql+pymysql://&lt;username&gt;:&lt;password&gt;@&lt;host&gt;/&lt;dbname&gt;[?&lt;options&gt;]

MySQL-Connector
    mysql+mysqlconnector://&lt;user&gt;:&lt;password&gt;@&lt;host&gt;[:&lt;port&gt;]/&lt;dbname&gt;

cx_Oracle
    oracle+cx_oracle://user:pass@host:port/dbname[?key=value&amp;key=value...]</code></pre><h1 id="方法一：使用Pymysql与SQLAlchemy操作数据库"><a href="#方法一：使用Pymysql与SQLAlchemy操作数据库" class="headerlink" title="方法一：使用Pymysql与SQLAlchemy操作数据库"></a>方法一：使用Pymysql与SQLAlchemy操作数据库</h1><pre><code># coding=utf-8

from sqlalchemy import create_engine

engine = create_engine(&quot;mysql+pymysql://root:xiaoming.note5@115.159.193.77:3306/school?charset=utf8&quot;, max_overflow=5)

# 执行SQL
cur = engine.execute(
    &quot;insert into user (name, password) values(&apos;lihy&apos;, &apos;lihy&apos;)&quot;
    )

# 新插入行自增ID
cur.lastrowid

# 执行SQL
cur = engine.execute(
    &quot;insert into user(name, password) values(%s, %s)&quot;, [(&apos;liq&apos;, &apos;liq&apos;), (&apos;liuxj&apos;, &apos;liuxj235&apos;)]
    )

# 执行SQL
cur = engine.execute(
    &quot;insert into user(name, password) values(%(name)s, %(password)s)&quot;, name=&apos;lium&apos;, password=&apos;lium123&apos;
    )

# 执行SQL
cur = engine.execute(&apos;select * from user&apos;)

# 获取第一行数据, 第n行，所有数据
cur.fetchone()
cur.fetchmany(3)
cur.fetchall()</code></pre><h1 id="方法二：使用SQLALchemy操作数据库"><a href="#方法二：使用SQLALchemy操作数据库" class="headerlink" title="方法二：使用SQLALchemy操作数据库"></a>方法二：使用SQLALchemy操作数据库</h1><h2 id="初始化对象"><a href="#初始化对象" class="headerlink" title="初始化对象"></a>初始化对象</h2><pre><code># -*-coding:utf-8-*-
from flask import Flask
from flask_sqlalchemy import SQLAlchemy
import datetime

app = Flask(__name__)
app.config[&apos;SQLALCHEMY_DATABASE_URI&apos;] = &apos;mysql+pymysql://root:root@127.0.0.1:3306/movie&apos;
# 用于连接数据的数据库
app.config[&apos;SQLALCHEMY_TRACK_MODIFICATIONS&apos;] = True
# 如果设置成 True (默认情况)，Flask-SQLAlchemy 将会追踪对象的修改并且发送信号。

db = SQLAlchemy(app)
# 实例化db对象</code></pre><h2 id="创建数据库模型"><a href="#创建数据库模型" class="headerlink" title="创建数据库模型"></a>创建数据库模型</h2><pre><code>class User(db.Model):
    __tablename__ = &apos;user&apos;
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(35), unique=True)
    pwd = db.Column(db.String(20))
    phone = db.Column(db.String(11), unique=True)

    def __repr__(self):
    # repr返回一个对象的 string 格式,repr的用法是：比如a=&apos;admin&apos;,repr(a)&gt;&gt;&gt;“‘admin’”
    return &apos;&lt;User %r&gt;&apos;%self.name</code></pre><h2 id="数据库外键关联"><a href="#数据库外键关联" class="headerlink" title="数据库外键关联"></a>数据库外键关联</h2><p>关系使用 relationship() 函数表示。然而外键必须用类 sqlalchemy.schema.ForeignKey 来单独声明:</p>
<pre><code>class Person(db.Model):
    __tablename__ = &apos;persion&apos;
    id = db.Column(db.Integer,primary_key=True,autoincrement=True)
    name = db.Column(db.String(100),index=True)
    pwd = db.Column(db.String(100),index=True)
    info = db.relationship(&apos;Address&apos;,backref = &apos;ss&apos;)


class Address(db.Model):
    __tablename__ = &apos;address&apos;
    id = db.Column(db.Integer, primary_key=True)
    email = db.Column(db.String(50))
    persion_id = db.Column(db.Integer, db.ForeignKey(&apos;persion.id&apos;))</code></pre><p>上面的例子中，address表中的person_id关联对象为person表的id的值。随后在person表中设置关联属性,关联属性名为info，第一个参数指向Address模型，另一个名叫backref的参数,叫做反向关系,我们将其设置成backref=ss。设置好了后它会向Persion模型中添加一个名为info的属性，这个属性可以代替persion_id去直接访问Persion模型的对象。</p>
<pre><code>&gt;&gt;&gt;r=persion(id=1,name=&apos;admin&apos;)
&gt;&gt;&gt;u=User(id=10,name=&apos;Hyman&apos;,persion_id=1)
&gt;&gt;&gt;r.info.append(u)
&gt;&gt;&gt;print u.role
    &lt;Persion admin&gt;</code></pre><p>我们将u添加到r的info中,这样我们同时也在u中添加了一个名叫做persion的属性,而这属性就是我们定义的r对象.这就是所谓的可以用info代替persion_id访问Role模型,但是它获取的是Persion模型对象而非器对应的id的值…</p>
<p>如果使用MYSQL语句创建数据库然后使用外键关联的话，这么写：</p>
<pre><code>用户表
create table user(
id int primary key autoincrement,
username varchar(100) not null
)

文章表
create table article(
id int primary key autoincrement,
title varchar(100) not null,
content text,
authot_id int, //这个是关联用户表的id字典，要记住一个表的外键一定是另一个表的主键
foreign ket &apos;author_id&apos; references &apos;user.id&apos;
)</code></pre><p>就这个例子如果使用SQLALchemy的话，创建模型这么写</p>
<pre><code>class User(db.Model):
    __tablename__ = &apos;user&apos;
    id = db.Column(db.Integer,primary_key=True,autoincrement=True)
    username = db.Column(db.String(100),nullable=False)

class Article(db.Model):
    __tablename__ = &apos;article&apos;
    id = db.Column(db.Integer,primary_key=True,autoincrement=True)
    title = db.Column(db.String(100),nullable=False)
    content = db.Column(db.Text)
    author_id = db.Column(db.Integer,db.ForeignKey(&apos;user.id&apos;))# 引用user表的id字段</code></pre><p><a href="https://www.cnblogs.com/programmer-tlh/p/5782451.html" target="_blank" rel="noopener">MySQL主键和外键使用及说明</a></p>
<h2 id="执行创建数据库"><a href="#执行创建数据库" class="headerlink" title="执行创建数据库"></a>执行创建数据库</h2><pre><code>db.create_all()</code></pre><h2 id="增删改查"><a href="#增删改查" class="headerlink" title="增删改查"></a>增删改查</h2><p>向数据库插入数据分为三个步骤:</p>
<ul>
<li>创建 Python 对象</li>
<li>把它添加到会话</li>
<li>提交会话</li>
</ul>
<h3 id="增"><a href="#增" class="headerlink" title="增"></a>增</h3><pre><code>from 你的数据库模型文件 import 你创建的数据库中的表名
me =  你创建的数据库中的表名(&apos;admin&apos;,&apos;18&apos;)
db.session.add(me)
db.session.commit()</code></pre><h3 id="删"><a href="#删" class="headerlink" title="删"></a>删</h3><pre><code>db.session.delete(me)
db.session.commit()</code></pre><h3 id="查"><a href="#查" class="headerlink" title="查"></a>查</h3><p>假设数据库中有如下条目,并且下面条目的表名为User:</p>
<pre><code>id    username    email
1    admin    admin@example.com
2    peter    peter@example.org
3    guest    guest@example.com</code></pre><p>获取所有数据:</p>
<pre><code>res = User.query(username).all()</code></pre><p>获取返回数据的第一行:</p>
<pre><code>res = User.query(username).first()</code></pre><p>过滤数据:</p>
<pre><code>res = User.query(username).filter(id&gt;1).all()</code></pre><p>limit:</p>
<pre><code>res = User.query(username).all()[1:3]</code></pre><p>and or:</p>
<pre><code>from sqlalchemy import and_
User.query.filter(and_(id==1, username==&apos;admin&apos;)).all()
User.query.filter(id==1, username==&apos;admin&apos;).all()
User.query.filter(id==1).filter(username==&apos;admin&apos;).all()
from sqlalchemy import or_
User.query.filter(or_(id==1, id==2)).all()</code></pre><p>多条件查询:</p>
<pre><code>res = User.query(username).filter(id&gt;0).filter(id&lt;7).all()</code></pre><p>通过用户名查询用户:</p>
<pre><code>peter = User.query.filter_by(username=&apos;peter&apos;).first()
peter.id
&gt;&gt;&gt; 1
peter.email
&gt;&gt;&gt;  peter@example.org</code></pre><p>如果查询一个不存在的用户名返回 None</p>
<p>使用更复杂的表达式查询一些用户:</p>
<pre><code>User.query.filter(User.email.endswith(&apos;@example.com&apos;)).all()
&gt;&gt;&gt; [&lt;User u&apos;admin&apos;&gt;, &lt;User u&apos;guest&apos;&gt;]</code></pre><p>返回对象是列表</p>
<p>按某种规则对用户排序:</p>
<pre><code>User.query.order_by(User.username)
&gt;&gt;&gt; [&lt;User u&apos;admin&apos;&gt;, &lt;User u&apos;guest&apos;&gt;, &lt;User u&apos;peter&apos;&gt;]</code></pre><p>限制返回用户的数量:</p>
<pre><code>User.query.limit(1).all()
&gt;&gt;&gt; [&lt;User u&apos;admin&apos;&gt;]</code></pre><p><code>filter_by</code>和<code>filter</code>都是过滤条件，只是用法有区别<code>filter_by</code>里面不能用<code>!=</code>还有<code>&gt; &lt;</code> 等等，所有<code>filter</code>用得更多,<code>filter_by</code>只能用<code>=</code>。</p>
<h3 id="改"><a href="#改" class="headerlink" title="改"></a>改</h3><pre><code>res = User.query.filter(User.username=&apos;admin&apos;).first()
res.username=&apos;root&apos;
db.sission.commit()</code></pre><h3 id="实例演示一"><a href="#实例演示一" class="headerlink" title="实例演示一"></a>实例演示一</h3><pre><code>#coding:utf-8
from flask_sqlalchemy import SQLAlchemy
from flask import Flask,render_template
app = Flask(__name__,template_folder=&apos;&apos;)
app.config[&apos;SQLALCHEMY_DATABASE_URI&apos;] = &apos;mysql+pymysql://root:root@127.0.0.1:3306/test404?charset=utf8&apos;
app.config[&apos;SQLALCHEMY_TRACK_MODIFICATIONS&apos;] = True
db = SQLAlchemy(app)


class Article(db.Model):
    __tablename__ = &apos;article&apos;
    id = db.Column(db.Integer,primary_key=True,autoincrement=True)
    title = db.Column(db.String(50),index=True)
    content = db.Column(db.Text)

db.create_all()

@app.route(&apos;/&apos;)
def index():
    # # 添加数据
    # # insert article(title,content) values(&apos;妹子大粑粑&apos;,&apos;AAbbCCaaaeeA啊啊&apos;)
    # ti = Article(title = &apos;妹子大粑粑&apos;,content=&apos;AAbbCCaaaeeA啊啊&apos;)
    # db.session.add(ti)
    # db.session.commit()

    # # 查询数据
    # # select * from article where title=&apos;妹子大粑粑&apos;
    # result = Article.query.filter(Article.title==&apos;妹子大粑粑&apos;).first().content
    # # 第一条的内容
    # res1 = Article.query.filter(Article.title==&apos;妹子大粑粑&apos;).all()[0].content
    # # 第一条的内容
    # return render_template(&apos;index.html&apos;,x=res1)

    # # 修改数据
    # # 先查询到要修改的数据，然后对需要修改的地方修改，然后提交
    # result = Article.query.filter(Article.title == &apos;妹子大粑粑&apos;).first()
    # result.content = &apos;啊啊啊啊啊啊啊啊啊去啊啊啊啊啊啊啊土拨鼠啊&apos;
    # db.session.commit()

    # # 删除数据
    # # 同上
    # result = Article.query.filter(Article.title == &apos;妹子大粑粑&apos;).first()
    # db.session.delete(result)
    # db.session.commit()

app.run(debug=True)</code></pre><h3 id="实例演示二"><a href="#实例演示二" class="headerlink" title="实例演示二"></a>实例演示二</h3><p>创建一个数据库对象</p>
<pre><code>class Person(Base):
    __tablename__ = &apos;person&apos;

    id   = Column(Integer, primary_key=True)
    name = Column(String(32))

    def __repr__(self):
        return &quot;&lt;Person(name=&apos;%s&apos;)&gt;&quot; % self.name</code></pre><h4 id="添加数据"><a href="#添加数据" class="headerlink" title="添加数据"></a>添加数据</h4><h5 id="创建一个person对象"><a href="#创建一个person对象" class="headerlink" title="创建一个person对象"></a>创建一个person对象</h5><pre><code>person = Person(name=&apos;jack&apos;)</code></pre><h5 id="添加person对象，但是仍然没有commit到数据库"><a href="#添加person对象，但是仍然没有commit到数据库" class="headerlink" title="添加person对象，但是仍然没有commit到数据库"></a>添加person对象，但是仍然没有commit到数据库</h5><pre><code>session.add(person)</code></pre><h5 id="commit操作"><a href="#commit操作" class="headerlink" title="commit操作"></a>commit操作</h5><pre><code>session.commit()</code></pre><p>如何获取id的？</p>
<pre><code>&gt;&gt;&gt; person = Person(name=&apos;ilis&apos;)
&gt;&gt;&gt; person.id #此时还没有commit到mysql,因此无id
&gt;&gt;&gt; session.add(person)
&gt;&gt;&gt; person.id #同上
&gt;&gt;&gt; session.commit()
2015-08-18 23:08:23,530 INFO sqlalchemy.engine.base.Engine INSERT INTO person (name) VALUES (%s)
2015-08-18 23:08:23,531 INFO sqlalchemy.engine.base.Engine (&apos;ilis&apos;,)
2015-08-18 23:08:23,532 INFO sqlalchemy.engine.base.Engine COMMIT
&gt;&gt;&gt; person.id #commit后，可以获取该对象的id
2015-08-18 23:08:27,556 INFO sqlalchemy.engine.base.Engine BEGIN (implicit)
2015-08-18 23:08:27,557 INFO sqlalchemy.engine.base.Engine SELECT person.id AS person_id, person.name AS person_name
FROM person
WHERE person.id = %s
2015-08-18 23:08:27,557 INFO sqlalchemy.engine.base.Engine (5L,)
5L
&gt;&gt;&gt;</code></pre><p>添加多个数据</p>
<pre><code>session.add_all([
    Person(name=&apos;jack&apos;),
    Person(name=&apos;mike&apos;)
])
session.commit()</code></pre><p>回滚</p>
<pre><code>&gt;&gt;&gt; person = Person(name=&apos;test&apos;)
&gt;&gt;&gt; session.add(person)
&gt;&gt;&gt; session.query(person).filter(name==&apos;test&apos;)
&gt;&gt;&gt; session.query(Person).filter(Person.name==&apos;test&apos;).all()
2015-08-18 23:13:23,265 INFO sqlalchemy.engine.base.Engine INSERT INTO person (name) VALUES (%s)
2015-08-18 23:13:23,265 INFO sqlalchemy.engine.base.Engine (&apos;test&apos;,)
2015-08-18 23:13:23,267 INFO sqlalchemy.engine.base.Engine SELECT person.id AS person_id, person.name AS person_name
FROM person
WHERE person.name = %s
2015-08-18 23:13:23,267 INFO sqlalchemy.engine.base.Engine (&apos;test&apos;,)
[&lt;demo.Person object at 0x7f4e37730510&gt;]
&gt;&gt;&gt; session.rollback()
2015-08-18 23:13:37,496 INFO sqlalchemy.engine.base.Engine ROLLBACK
&gt;&gt;&gt; session.query(Person).filter(Person.name==&apos;test&apos;).all()
2015-08-18 23:13:38,690 INFO sqlalchemy.engine.base.Engine BEGIN (implicit)
2015-08-18 23:13:38,691 INFO sqlalchemy.engine.base.Engine SELECT person.id AS person_id, person.name AS person_name
FROM person
WHERE person.name = %s
2015-08-18 23:13:38,692 INFO sqlalchemy.engine.base.Engine (&apos;test&apos;,)
[]
&gt;&gt;&gt;</code></pre><p>数据查询</p>
<p>使用Session的query()方法。</p>
<h5 id="获取所有数据"><a href="#获取所有数据" class="headerlink" title="获取所有数据"></a>获取所有数据</h5><pre><code>session.query(Person).all()</code></pre><h5 id="获取某一列数据-类似于django的get-如果返回数据为多个则报错"><a href="#获取某一列数据-类似于django的get-如果返回数据为多个则报错" class="headerlink" title="获取某一列数据,类似于django的get,如果返回数据为多个则报错"></a>获取某一列数据,类似于django的get,如果返回数据为多个则报错</h5><p>session.query(Person).filter(Person.name==’jack’).one()</p>
<h5 id="获取返回数据的第一行"><a href="#获取返回数据的第一行" class="headerlink" title="获取返回数据的第一行"></a>获取返回数据的第一行</h5><pre><code>session.query(Person).first()</code></pre><h5 id="过滤数据"><a href="#过滤数据" class="headerlink" title="过滤数据"></a>过滤数据</h5><pre><code>session.query(Person.name).filter(Person.id&gt;1).all()</code></pre><h5 id="limit"><a href="#limit" class="headerlink" title="limit"></a>limit</h5><pre><code>session.query(Person).all()[1:3]</code></pre><h5 id="order-by"><a href="#order-by" class="headerlink" title="order by"></a>order by</h5><pre><code>session.query(Person).ordre_by(-Person.id)</code></pre><h5 id="equal-like-in"><a href="#equal-like-in" class="headerlink" title="equal/like/in"></a>equal/like/in</h5><pre><code>query = session.query(Person)
query.filter(Person.id==1).all()
query.filter(Person.id!=1).all()
query.filter(Person.name.like(&apos;%ac%&apos;)).all()
query.filter(Person.id.in_([1,2,3])).all()
query.filter(~Person.id.in_([1,2,3])).all()
query.filter(Person.name==None).all()</code></pre><h5 id="and-or"><a href="#and-or" class="headerlink" title="and or"></a>and or</h5><pre><code>from sqlalchemy import and_
query.filter(and_(Person.id==1, Person.name==&apos;jack&apos;)).all()
query.filter(Person.id==1, Person.name==&apos;jack&apos;).all()
query.filter(Person.id==1).filter(Person.name==&apos;jack&apos;).all()
from sqlalchemy import or_
query.filter(or_(Person.id==1, Person.id==2)).all()</code></pre><h5 id="使用text"><a href="#使用text" class="headerlink" title="使用text"></a>使用text</h5><pre><code>from sqlalchemy import text
query.filter(text(&quot;id&gt;1&quot;)).all()
query.filter(Person.id&gt;1).all() #同上
query.filter(text(&quot;id&gt;:id&quot;)).params(id=1).all() #使用:，params来传参

query.from_statement(
    text(&quot;select * from person where name=:name&quot;)).\
    params(name=&apos;jack&apos;).all()</code></pre><h5 id="计数"><a href="#计数" class="headerlink" title="计数"></a>计数</h5><p>Query使用count()函数来实现查询计数。</p>
<pre><code>query.filter(Person.id&gt;1).count()</code></pre><h5 id="group-by的用法"><a href="#group-by的用法" class="headerlink" title="group by的用法"></a>group by的用法</h5><pre><code>from sqlalchemy import func
session.query(func.count(Person.name), Person.name),group_by(Person.name).all()</code></pre><h5 id="实现count-来查询表内行数"><a href="#实现count-来查询表内行数" class="headerlink" title="实现count(*)来查询表内行数"></a>实现count(*)来查询表内行数</h5><pre><code>session.query(func.count(&apos;*&apos;)).select_from(Person).scalar()
session.query(func.count(Person.id)).scalar()</code></pre><h1 id="Pymysql-with-操作"><a href="#Pymysql-with-操作" class="headerlink" title="Pymysql with 操作"></a>Pymysql with 操作</h1><pre><code>import contextlib
@contextlib.contextmanager
def mysql(host=&apos;127.0.0.1&apos;,user=&apos;root&apos;,passwd=&apos;root&apos;,db=&apos;meizi&apos;,port=3306,charset=&apos;utf8&apos;):
    conn = pymysql.connect(host=&apos;127.0.0.1&apos;,user=&apos;root&apos;,passwd=&apos;root&apos;,db=&apos;meizi&apos;,port=3306,charset=&apos;utf8&apos;)
    cursor = conn.cursor()
    try:
        yield cursor
    finally:
        conn.commit()
        cursor.close()
        conn.close()
# # 执行sql
# with mysql() as cursor:
#    print(cursor)
#    row_count = cursor.execute(&quot;select * from tb7&quot;)
#    row_1 = cursor.fetchone()
#    print row_count, row_1</code></pre><h1 id="SQLALchemy-with操作"><a href="#SQLALchemy-with操作" class="headerlink" title="SQLALchemy with操作"></a>SQLALchemy with操作</h1><p>SQLALCHEMY使用的是连接池进行数据操作，但是不同的页面操作数据耗时不一样，这就导致后面的进行执行插入数据的时候没有足够的进程可以提供操作就报错，解决方法及时扩大连接池加使用上下文管理，是每个操作及时关闭。</p>
<pre><code>SQLALCHEMY_DATABASE_URI = &apos;mysql+pymysql://127.0.0.1/database?charset=utf8&apos;
SQLALCHEMY_TRACK_MODIFIACTIONS = False
SQLALCHEMY_POOL_SIZE = 50
SQLALCHEMY_POOL_TIMEOUT = 30
SQLALCHEMY_POOL_RECYCLE = -1</code></pre><p>在数据库模型设计文件中，新写一个上下文管理器</p>
<pre><code>@contextlib.contextmanager
def data2mysql():
    try:
        yield db
    except:
        db.session.rollback()
    finally:
        db.session.remove()</code></pre><p>在别的所有调用db.session()方法中全部使用with操作，节省连接池。</p>
<pre><code>url = &apos;https://sxadmin.github.io&apos;
first_ins = url_index(url=url)
with data2mysql() as dbs:
    dbs.session.add(first_ins)
    dbs.session.commit()</code></pre><h1 id="数据库连接池"><a href="#数据库连接池" class="headerlink" title="数据库连接池"></a>数据库连接池</h1><p>DBUtils是Python的一个用于实现数据库连接池的模块</p>
<p>此连接池有两种连接模式：</p>
<pre><code>DBUtils提供两种外部接口：
PersistentDB ：提供线程专用的数据库连接，并自动管理连接。
PooledDB ：提供线程间可共享的数据库连接，并自动管理连接。</code></pre><h2 id="PersistentDB-模式"><a href="#PersistentDB-模式" class="headerlink" title="PersistentDB 模式"></a>PersistentDB 模式</h2><p>为每个线程创建一个连接，线程即使调用了close方法，也不会关闭，只是把链接重新放到链接池，供自己线程再次使用，当线程终止时，链接自动关闭</p>
<pre><code>from DBUtils.PersistentDB import PersistentDB
import pymysql
POOL = PersistentDB(
    creator=pymysql,  # 使用链接数据库的模块
    maxusage=None,  # 一个链接最多被重复使用的次数，None表示无限制
    setsession=[],  # 开始会话前执行的命令列表。
    ping=0,
    # ping MySQL服务端，检查是否服务可用。
    closeable=False,
    # 如果为False时， conn.close() 实际上被忽略，供下次使用，再线程关闭时，才会自动关闭链接。如果为True时， conn.close()则关闭链接，那么再次调用pool.connection时就会报错，因为已经真的关闭了连接（pool.steady_connection()可以获取一个新的链接）
    threadlocal=None,  # 本线程独享值得对象，用于保存链接对象，如果链接对象被重置
    host=&apos;127.0.0.1&apos;,
    port=3306,
    user=&apos;root&apos;,
    password=&apos;123456&apos;,
    database=&apos;test&apos;,
    charset=&apos;utf8&apos;
)

def func():
    conn = POOL.connection(shareable=False)
    cursor = conn.cursor()
    cursor.execute(&apos;select * from user&apos;)
    result = cursor.fetchall()
    print(result)
    cursor.close()
    conn.close()
if __name__ == &apos;__main__&apos;:

    func()</code></pre><h2 id="PooledDB-模式"><a href="#PooledDB-模式" class="headerlink" title="PooledDB 模式"></a>PooledDB 模式</h2><p>创建一批连接到连接池，供所有线程共享使用。</p>
<pre><code>import pymysql

from DBUtils.PooledDB import PooledDB
POOL = PooledDB(
    creator=pymysql,  # 使用链接数据库的模块
    maxconnections=6,  # 连接池允许的最大连接数，0和None表示不限制连接数
    mincached=2,  # 初始化时，链接池中至少创建的空闲的链接，0表示不创建
    maxcached=5,  # 链接池中最多闲置的链接，0和None不限制
    maxshared=3,  # 链接池中最多共享的链接数量，0和None表示全部共享。PS: 无用，因为pymysql和MySQLdb等模块的 threadsafety都为1，所有值无论设置为多少，_maxcached永远为0，所以永远是所有链接都共享。
    blocking=True,  # 连接池中如果没有可用连接后，是否阻塞等待。True，等待；False，不等待然后报错
    maxusage=None,  # 一个链接最多被重复使用的次数，None表示无限制
    setsession=[],  # 开始会话前执行的命令列表。
    ping=0,
    # ping MySQL服务端，检查是否服务可用。
    host=&apos;127.0.0.1&apos;,
    port=3306,
    user=&apos;root&apos;,
    password=&apos;123456&apos;,
    database=&apos;test&apos;,
    charset=&apos;utf8&apos;
)


def func():
    # 检测当前正在运行连接数的是否小于最大链接数，如果不小于则：等待或报raise TooManyConnections异常
    # 否则
    # 则优先去初始化时创建的链接中获取链接 SteadyDBConnection。
    # 然后将SteadyDBConnection对象封装到PooledDedicatedDBConnection中并返回。
    # 如果最开始创建的链接没有链接，则去创建一个SteadyDBConnection对象，再封装到PooledDedicatedDBConnection中并返回。
    # 一旦关闭链接后，连接就返回到连接池让后续线程继续使用。
    conn = POOL.connection()

    # print(th, &apos;链接被拿走了&apos;, conn1._con)
    # print(th, &apos;池子里目前有&apos;, pool._idle_cache, &apos;\r\n&apos;)

    cursor = conn.cursor()
    cursor.execute(&apos;select * from user&apos;)
    result = cursor.fetchall()
    print(result)
    conn.close()

if __name__ == &apos;__main__&apos;:

    func()</code></pre><p><a href="https://www.cnblogs.com/moyand/p/9046862.html" target="_blank" rel="noopener">转载地址</a></p>
<p><a href="http://www.pythondoc.com/flask-sqlalchemy/" target="_blank" rel="noopener">官方文档</a></p>
<p><a href="http://www.cnblogs.com/jishuweiwang/p/5713798.html" target="_blank" rel="noopener">参考链接</a></p>
<p><a href="https://www.jianshu.com/p/ed32d69383d2" target="_blank" rel="noopener">参考链接</a></p>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Sxadmin</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://sxadmin.github.io/2018/07/24/Flask%20SQLAlchemy%20%E6%95%B0%E6%8D%AE%E5%BA%93/">https://sxadmin.github.io/2018/07/24/Flask%20SQLAlchemy%20%E6%95%B0%E6%8D%AE%E5%BA%93/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://sxadmin.github.io" target="_blank">Sxadmin blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Flask-%E6%95%B0%E6%8D%AE%E5%BA%93/">Flask 数据库</a><a class="post-meta__tags" href="/tags/sqlalchemy/">sqlalchemy</a><a class="post-meta__tags" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E6%98%A0%E5%B0%84/">数据库映射</a></div><div class="post_share"><div class="social-share" data-image="/img/cover/cover13.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"/><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/2018/08/15/Flask-Movie-%E5%B0%8F%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/"><img class="prev_cover" src="/img/cover/cover15.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Flask-Movie-小项目实战</div></div></a></div><div class="next-post pull_right"><a href="/2018/07/22/Flask%20Wtforms%20%E8%A1%A8%E5%8D%95%E9%AA%8C%E8%AF%81/"><img class="next_cover" src="/img/cover/cover25.png" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Flask Wtforms 表单验证</div></div></a></div></nav></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By Sxadmin</div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@3/instantpage.min.js" type="module"></script></body></html>